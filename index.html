<!DOCTYPE html>
<html lang="pl">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="password-protect.js"></script> 

    <!-- Umami Analytics -->
    <script defer src="https://cloud.umami.is/script.js" data-website-id="0b96c829-a037-4b08-93d8-b56a166dd79b"
        data-do-not-track="true"></script>

    <title>WOS TD2 - Generator ostrze≈ºe≈Ñ sta≈Çych</title>
    <style>
        :root {
            --bg-body: #f9f9f9;
            --bg-container: #ffffff;
            --text-color: #000000;
            --text-heading: #0d47a1;
            --border-color: #666666;
            --border-light: #aaaaaa;
            --input-bg: #ffffff;
            --btn-bg: #0d47a1;
            --btn-hover: #1565c0;
            --btn-text: #ffffff;
            --link-text: #000000;

            --table-border: #000000;
            --th-bg: #e8e8e8;
            --station-header-bg: #fffacd;
            --station-header-text: #000000;
            --tab-bg: #f0f0f0;
            --tab-active: #0d47a1;
            --tab-hover: #e0e0e0;
        }

        body.dark-mode {
            --bg-body: #121212;
            --bg-container: #1e1e1e;
            --text-color: #e0e0e0;
            --text-heading: #64b5f6;
            --border-color: #555555;
            --border-light: #444444;
            --input-bg: #2d2d2d;
            --btn-bg: #64b5f6;
            --btn-hover: #42a5f5;
            --btn-text: #000000;
            --link-text: #e0e0e0;

            --table-border: #555555;
            --th-bg: #333333;
            --station-header-bg: #4a4a2a;
            --station-header-text: #e0e0e0;
            --tab-bg: #2a2a2a;
            --tab-active: #64b5f6;
            --tab-hover: #3a3a3a;
        }

        body {
            font-family: Arial, Helvetica, sans-serif;
            margin: 20px;
            background: var(--bg-body);
            color: var(--text-color);
            transition: background 0.3s, color 0.3s;
        }

        h1 {
            color: var(--text-heading);
            text-align: center;
            margin-bottom: 0.4em;
        }

        a {
            color: var(--link-text);
        }

        .container {
            background: var(--bg-container);
            padding: 20px;
            border: 1px solid var(--border-light);
            max-width: 1500px;
            margin: 0 auto 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.15);
            transition: background 0.3s, border-color 0.3s;
            position: relative;
        }

        select,
        input[type="text"] {
            width: 100%;
            padding: 10px;
            margin: 5px 0 15px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-family: monospace;
            font-size: 1.05em;
            background: var(--input-bg);
            color: var(--text-color);
            box-sizing: border-box;
        }

        .search-row {
            display: flex;
            gap: 15px;
            margin-bottom: 10px;
        }

        .search-group {
            flex: 1;
        }

        .search-group label {
            font-size: 0.9em;
            font-weight: bold;
            display: block;
            margin-bottom: 3px;
        }

        button {
            padding: 10px 22px;
            margin: 0 10px 10px 0;
            background: var(--btn-bg);
            color: var(--btn-text);
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.2s;
        }

        button:hover {
            background: var(--btn-hover);
        }

        button:disabled {
            background: #555;
            cursor: not-allowed;
            opacity: 0.7;
        }

        #theme-toggle-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 8px 12px;
            font-size: 0.9em;
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-color);
        }

        .wos-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 9.5pt;
            margin-top: 12px;
            color: var(--text-color);
        }

        .wos-table th,
        .wos-table td {
            border: 1px solid var(--table-border);
            padding: 4px 6px;
            text-align: center;
            vertical-align: middle;
        }

        .wos-table th {
            background-color: var(--th-bg);
            font-weight: bold;
        }

        .wos-table .station-header {
            background-color: var(--station-header-bg);
            color: var(--station-header-text);
            font-size: 11pt;
            font-weight: bold;
            text-align: left;
            padding-left: 12px;
            height: 30px;
        }

        /* Tab styles */
        .tabs {
            display: flex;
            border-bottom: 2px solid var(--border-color);
            margin-bottom: 20px;
        }

        .tab {
            padding: 12px 24px;
            background: var(--tab-bg);
            border: 1px solid var(--border-color);
            border-bottom: none;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            margin-right: 2px;
            border-radius: 4px 4px 0 0;
        }

        .tab:hover {
            background: var(--tab-hover);
        }

        .tab.active {
            background: var(--tab-active);
            color: white;
            border-color: var(--tab-active);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        @media print {
            .no-print {
                display: none !important;
            }

            body {
                margin: 0;
                background: white !important;
                color: black !important;
            }

            .container {
                border: none;
                box-shadow: none;
                padding: 0;
                margin: 0;
                background: white !important;
            }

            :root,
            body.dark-mode {
                --text-color: black;
                --text-heading: black;
                --table-border: black;
                --th-bg: #e8e8e8;
                --station-header-bg: #fffacd;
                --station-header-text: black;
            }

            .tabs {
                display: none !important;
            }
        }

        @media (max-width: 600px) {
            .search-row {
                flex-direction: column;
                gap: 0;
            }

            .tabs {
                flex-direction: column;
            }

            .tab {
                margin-right: 0;
                margin-bottom: 2px;
                border-radius: 4px;
            }

            .tab.active {
                border-bottom: 1px solid var(--tab-active);
            }
        }

        /* Style dla komunikatu ostrzegawczego */
        .warning-message {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 15px;
            border-radius: 4px;
            margin: 20px 0;
        }

        body.dark-mode .warning-message {
            background: #664d03;
            border: 1px solid #966a03;
            color: #ffecb5;
        }
    </style>
</head>

<body>

    <div class="container no-print">
        <button id="theme-toggle-btn">üåô</button>

        <h1>Wykaz Ostrze≈ºe≈Ñ Sta≈Çych (WOS) ‚Äì TD2</h1>

        <!-- Server selector -->
        <div style="margin-bottom: 20px; text-align: center;">
            <label for="server-select" style="font-weight: bold; margin-right: 10px;">Wybierz serwer:</label>
            <select id="server-select" style="width: auto; display: inline-block;">
                <option value="eu">PL1</option>
                <option value="cae">PL2</option>
                <option value="ru">EN</option>
            </select>
        </div>

        <!-- Tab navigation -->
        <div class="tabs">
            <div class="tab active" data-tab="train-tab">WOS dla pociƒÖgu</div>
            <div class="tab" data-tab="station-tab">WOS dla stacji</div>
        </div>

        <!-- Tab 1: WOS dla pociƒÖgu -->
        <div id="train-tab" class="tab-content active">
            <div class="search-row">
                <div class="search-group">
                    <label for="search-nick">Szukaj po nicku:</label>
                    <input type="text" id="search-nick" list="list-nicks" placeholder="Wpisz nick maszynisty...">
                    <datalist id="list-nicks"></datalist>
                </div>
                <div class="search-group">
                    <label for="search-train">Szukaj po nr pociƒÖgu:</label>
                    <input type="text" id="search-train" list="list-trains" placeholder="Wpisz numer pociƒÖgu...">
                    <datalist id="list-trains"></datalist>
                </div>
            </div>

            <label for="maszynista">Pe≈Çna lista (Maszynista | PociƒÖg):</label>
            <select id="maszynista">
                <option value="">-- Wybierz maszynistƒô --</option>
            </select>

            <div style="margin: 10px 0;">
                <label style="font-weight: normal; cursor: pointer;">
                    <input type="checkbox" id="save-last-driver" style="margin-right: 8px;">
                    Zapamiƒôtaj ostatniego maszynistƒô
                </label>
            </div>

            <div>
                <button id="refreshButton" onclick="refreshDriversData()">üîÑ Od≈õwie≈º</button>
                <button id="printButton" disabled onclick="printWithFilename()">üñ®Ô∏è Drukuj / Zapisz jako PDF</button>
            </div>
        </div>

        <!-- Tab 2: WOS dla stacji -->
        <div id="station-tab" class="tab-content">
            <div class="search-group">
                <label for="search-station">Szukaj stacji:</label>
                <input type="text" id="search-station" list="list-stations" placeholder="Wpisz nazwƒô stacji...">
                <datalist id="list-stations"></datalist>
            </div>

            <label for="station-select">Wybierz stacjƒô z listy:</label>
            <select id="station-select">
                <option value="">-- Wybierz stacjƒô --</option>
            </select>

            <div>
                <button id="station-printButton" disabled onclick="printStationWithFilename()">üñ®Ô∏è Drukuj / Zapisz jako
                    PDF</button>
            </div>
        </div>
    </div>

    <div class="container">
        <div id="wynik"></div>
    </div>

    <script src="baza.js"></script>

    <script>
        const toggleBtn = document.getElementById('theme-toggle-btn');
        const body = document.body;
        const savedTheme = localStorage.getItem('wos_theme');
        if (savedTheme === 'dark') { body.classList.add('dark-mode'); toggleBtn.textContent = '‚òÄÔ∏è'; }

        toggleBtn.addEventListener('click', () => {
            body.classList.toggle('dark-mode');
            if (body.classList.contains('dark-mode')) {
                localStorage.setItem('wos_theme', 'dark');
                toggleBtn.textContent = '‚òÄÔ∏è';
            } else {
                localStorage.setItem('wos_theme', 'light');
                toggleBtn.textContent = 'üåô';
            }
        });

        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');

        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const targetTab = tab.dataset.tab;

                tabs.forEach(t => t.classList.remove('active'));
                tabContents.forEach(content => content.classList.remove('active'));

                tab.classList.add('active');
                document.getElementById(targetTab).classList.add('active');
            });
        });

        async function refreshDriversData() {
            const refreshButton = document.getElementById('refreshButton');
            const originalText = refreshButton.innerHTML;

            const mainSelect = document.getElementById('maszynista');
            const currentValue = mainSelect.value;
            const saveCheckboxState = document.getElementById('save-last-driver').checked;

            refreshButton.disabled = true;
            refreshButton.innerHTML = '‚è≥ ≈Åadowanie...';

            try {
                mainSelect.innerHTML = '<option value="">-- Wybierz maszynistƒô --</option>';
                document.getElementById('list-nicks').innerHTML = '';
                document.getElementById('list-trains').innerHTML = '';

                if (window.loadMaszynisciModule) {
                    await window.loadMaszynisciModule();
                }

                document.getElementById('save-last-driver').checked = saveCheckboxState;

            } catch (error) {
                console.error('B≈ÇƒÖd od≈õwie≈ºania:', error);
                document.getElementById("wynik").innerHTML = `
                <div class="warning-message">
                    <strong>‚ö†Ô∏è B≈ÇƒÖd:</strong> Nie uda≈Ço siƒô od≈õwie≈ºyƒá danych maszynist√≥w.
                    <br>Spr√≥buj ponownie p√≥≈∫niej.
                </div>
            `;
            } finally {
                refreshButton.disabled = false;
                refreshButton.innerHTML = originalText;
            }
        }

        function printWithFilename() {
            const maszynista = document.getElementById("maszynista").value;
            if (!maszynista) return;

            let trainNumber = 'bez-numeru';
            if (window.trainsDataModule && window.trainsDataModule.length > 0) {
                const train = window.trainsDataModule.find(t => t.driverName === maszynista);
                if (train && train.trainNo) {
                    trainNumber = train.trainNo;
                }
            }

            const originalTitle = document.title;
            const currentDate = new Date().toLocaleDateString('pl-PL').replace(/\./g, '-');
            document.title = `WOS dla pociƒÖgu ${trainNumber} z dnia ${currentDate}`;

            window.print();

            setTimeout(() => {
                document.title = originalTitle;
            }, 100);
        }

        function printStationWithFilename() {
            const station = document.getElementById('station-select').value;
            if (!station) return;

            const originalTitle = document.title;
            const currentDate = new Date().toLocaleDateString('pl-PL').replace(/\./g, '-');
            const stationName = station.replace(/[^a-zA-Z0-9ƒÖƒáƒô≈Ç≈Ñ√≥≈õ≈∫≈ºƒÑƒÜƒò≈Å≈É√ì≈ö≈π≈ª]/g, '_');
            document.title = `WOS dla stacji ${stationName} z dnia ${currentDate}`;

            window.print();

            setTimeout(() => {
                document.title = originalTitle;
            }, 100);
        }
    </script>

    <script>
        let trainsData = [];
        let stations = [];

        const nickToTrainMap = new Map();
        const trainToNickMap = new Map();

        async function loadMaszynisci() {
            const select = document.getElementById('maszynista');
            const dlNicks = document.getElementById('list-nicks');
            const dlTrains = document.getElementById('list-trains');
            const saveCheckbox = document.getElementById('save-last-driver');
            const serverSelect = document.getElementById('server-select');

            select.innerHTML = '<option value="">-- Wybierz maszynistƒô --</option>';
            dlNicks.innerHTML = '';
            dlTrains.innerHTML = '';

            nickToTrainMap.clear();
            trainToNickMap.clear();

            try {
                const response = await fetch('https://stacjownik.spythere.eu/api/getActiveData');
                if (!response.ok) throw new Error('B≈ÇƒÖd API');

                const data = await response.json();

                const selectedServer = serverSelect.value;
                let filteredTrains = data.trains;

                const serverRegionMap = {
                    'eu': 'eu',      // PL1
                    'cae': 'cae',    // PL2
                    'ru': 'ru'       // EN
                };

                const targetRegion = serverRegionMap[selectedServer];

                if (targetRegion) {
                    filteredTrains = data.trains.filter(train => train.region === targetRegion);
                    console.log(`Filtrujƒô dane dla serwera ${selectedServer} (region ${targetRegion}): ${filteredTrains.length} pociƒÖg√≥w`);
                } else {
                    console.log(`Serwer ${selectedServer} nie ma odpowiednika w API, u≈ºywam wszystkich danych`);
                }

                trainsData = filteredTrains;

                const maszynisciMap = new Map();
                trainsData.forEach(train => {
                    if (train.driverName) maszynisciMap.set(train.driverName, train);
                });

                const sortedNames = Array.from(maszynisciMap.keys()).sort((a, b) => a.localeCompare(b, 'pl'));

                const zRozkladem = sortedNames.filter(name => {
                    const t = maszynisciMap.get(name);
                    return t.timetable && t.timetable.path;
                });
                const bezRozkladu = sortedNames.filter(name => !zRozkladem.includes(name));

                zRozkladem.forEach(name => {
                    const train = maszynisciMap.get(name);
                    const trainNo = train.trainNo || "???";

                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = `${name} | ${trainNo}`;
                    select.appendChild(option);

                    const optNick = document.createElement('option');
                    optNick.value = name;
                    dlNicks.appendChild(optNick);

                    if (train.trainNo) {
                        const trainNoStr = String(train.trainNo).trim();

                        const optTrain = document.createElement('option');
                        optTrain.value = trainNoStr;
                        dlTrains.appendChild(optTrain);

                        nickToTrainMap.set(name, trainNoStr);
                        trainToNickMap.set(trainNoStr, name);
                    }
                });

                if (zRozkladem.length > 0 && bezRozkladu.length > 0) {
                    const separator = document.createElement('option');
                    separator.disabled = true;
                    separator.textContent = "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ BRAK ROZK≈ÅADU ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ";
                    select.appendChild(separator);
                }

                bezRozkladu.forEach(name => {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = `${name} (brak danych trasy)`;
                    option.disabled = true;
                    select.appendChild(option);
                });

                const savedDriver = localStorage.getItem('wos_last_driver');
                if (savedDriver) {
                    const savedDriverTrain = maszynisciMap.get(savedDriver);

                    if (savedDriverTrain && savedDriverTrain.timetable && savedDriverTrain.timetable.path) {
                        select.value = savedDriver;
                        saveCheckbox.checked = true;
                        updateStacjeFromMaszynista();
                    } else if (maszynisciMap.has(savedDriver)) {
                        saveCheckbox.checked = true;
                        document.getElementById("wynik").innerHTML = `
                        <div class="warning-message">
                            <strong>‚ö†Ô∏è Informacja:</strong> Obecnie ten maszynista nie posiada aktywnego rozk≈Çadu jazdy.
                            <br>Proszƒô wybraƒá innego maszynistƒô z listy powy≈ºej.
                        </div>
                    `;
                    } else {
                        localStorage.removeItem('wos_last_driver');
                    }
                }

            } catch (error) {
                console.error('B≈ÇƒÖd:', error);
                const option = document.createElement('option');
                option.textContent = 'B≈ÇƒÖd ≈Çadowania danych';
                select.appendChild(option);
            }
        }

        function loadStations() {
            const stationSelect = document.getElementById('station-select');
            const stationDatalist = document.getElementById('list-stations');

            const stationNames = Object.keys(BAZA_OSTRZEZEN).sort((a, b) => a.localeCompare(b, 'pl'));

            stationNames.forEach(stationName => {
                const option = document.createElement('option');
                option.value = stationName;
                option.textContent = stationName;
                stationSelect.appendChild(option);

                const datalistOption = document.createElement('option');
                datalistOption.value = stationName;
                stationDatalist.appendChild(datalistOption);
            });
        }

        const searchNickInput = document.getElementById('search-nick');
        const searchTrainInput = document.getElementById('search-train');
        const mainSelect = document.getElementById('maszynista');

        searchNickInput.addEventListener('input', (e) => {
            const val = e.target.value;
            if (nickToTrainMap.has(val)) {
                mainSelect.value = val;
                updateStacjeFromMaszynista();
                searchTrainInput.value = "";
            }
        });

        searchTrainInput.addEventListener('input', (e) => {
            const val = e.target.value.trim();
            if (trainToNickMap.has(val)) {
                const driverName = trainToNickMap.get(val);
                mainSelect.value = driverName;
                updateStacjeFromMaszynista();
                searchNickInput.value = "";
            }
        });

        mainSelect.addEventListener('change', () => {
            updateStacjeFromMaszynista();
            searchNickInput.value = "";
            searchTrainInput.value = "";

            const saveCheckbox = document.getElementById('save-last-driver');
            if (saveCheckbox.checked && mainSelect.value) {
                localStorage.setItem('wos_last_driver', mainSelect.value);
            }
        });

        document.getElementById('save-last-driver').addEventListener('change', (e) => {
            if (!e.target.checked) {
                localStorage.removeItem('wos_last_driver');
            } else if (mainSelect.value) {
                localStorage.setItem('wos_last_driver', mainSelect.value);
            }
        });

        window.trainsDataModule = trainsData;

        const searchStationInput = document.getElementById('search-station');
        const stationSelect = document.getElementById('station-select');

        searchStationInput.addEventListener('input', (e) => {
            const val = e.target.value;
            const matchingStation = Object.keys(BAZA_OSTRZEZEN).find(station =>
                normalizuj(station).includes(normalizuj(val))
            );

            if (matchingStation) {
                stationSelect.value = matchingStation;
                generujWOSDlaStacji();
            }
        });

        stationSelect.addEventListener('change', () => {
            generujWOSDlaStacji();
            searchStationInput.value = "";
        });

        function updateStacjeFromMaszynista() {
            const selectedDriver = document.getElementById("maszynista").value;
            if (!selectedDriver) return;

            const train = trainsData.filter(t => t.driverName === selectedDriver).find(t => t.timetable?.path);

            if (!train || !train.timetable?.path) {
                document.getElementById("wynik").innerHTML = "";
                return;
            }

            const pathStations = train.timetable.path
                .split(',')
                .map(segment => segment.split('@')[0].trim())
                .filter(name => name.includes('.sc'))
                .map(name => {
                    const match = name.match(/^(.+?)\s+[0-9a-f]{8}\.sc$/);
                    return match ? match[1] : name;
                });

            stations = pathStations.join(',');
            generujWOS();
            document.getElementById('printButton').disabled = false;
        }

        function generujWOSDlaStacji() {
            const selectedStation = document.getElementById('station-select').value;
            if (!selectedStation) {
                document.getElementById("wynik").innerHTML = "";
                document.getElementById('station-printButton').disabled = true;
                return;
            }

            const klucz = Object.keys(BAZA_OSTRZEZEN).find(k => normalizuj(k) === normalizuj(selectedStation));
            if (!klucz) {
                document.getElementById("wynik").innerHTML = "<p>Brak danych dla wybranej stacji.</p>";
                document.getElementById('station-printButton').disabled = true;
                return;
            }

            let lp = 1;
            let html = `
        <h1 style="margin:0 0 12px; font-size:15pt; text-align:center; color: var(--text-color);">
            Wykaz Ostrze≈ºe≈Ñ Sta≈Çych<br>
            oraz prƒôdko≈õci drogowych
        </h1>
        <span style="float:right;">Godzina wydruku: <b>${new Date().toLocaleTimeString('pl-PL')}</b></span>
        <span><br><br></span>
        <span>Wygenerowano dla stacji: <b>${klucz}</b></span>
        ${rysujWOS([klucz])}
        `;
            document.getElementById("wynik").innerHTML = html;
            document.getElementById('station-printButton').disabled = false;
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadMaszynisci();
            loadStations();

            const serverSelect = document.getElementById('server-select');
            serverSelect.value = 'eu';

            serverSelect.addEventListener('change', async () => {
                console.log('Zmieniono serwer na:', serverSelect.value);

                try {
                    await loadMaszynisci();
                    window.trainsDataModule = trainsData;
                    console.log('Dane za≈Çadowane pomy≈õlnie');
                } catch (error) {
                    console.error('B≈ÇƒÖd ≈Çadowania danych:', error);
                    document.getElementById('maszynista').innerHTML = '<option value="">-- B≈ÇƒÖd ≈Çadowania --</option>';
                }
            });

            loadMaszynisci();
        });

        function normalizuj(nazwa) {
            return (nazwa || "").trim().toLowerCase()
                .replace(/[ƒÖƒáƒô≈Ç≈Ñ√≥≈õ≈∫≈º]/g, c => ({ 'ƒÖ': 'a', 'ƒá': 'c', 'ƒô': 'e', '≈Ç': 'l', '≈Ñ': 'n', '√≥': 'o', '≈õ': 's', '≈∫': 'z', '≈º': 'z' })[c] || c);
        }

        function formatKm(km) { return km ? km.replace('.', ',') : '‚Äî'; }

        async function refreshDriversData() {
            const refreshButton = document.getElementById('refreshButton');
            const originalText = refreshButton.textContent;

            try {
                refreshButton.textContent = 'üîÑ ≈Åadowanie...';
                refreshButton.disabled = true;

                await loadMaszynisci();
                window.trainsDataModule = trainsData;

                // Zachowaƒá wybranego maszynistƒô je≈õli nadal istnieje
                const currentSelection = document.getElementById('maszynista').value;
                if (currentSelection) {
                    const driverExists = trainsData.some(t => t.driverName === currentSelection);
                    if (driverExists) {
                        document.getElementById('maszynista').value = currentSelection;
                        updateStacjeFromMaszynista();
                    }
                }

                refreshButton.textContent = '‚úÖ Od≈õwie≈ºono';
                setTimeout(() => {
                    refreshButton.textContent = originalText;
                    refreshButton.disabled = false;
                }, 1500);

            } catch (error) {
                console.error('B≈ÇƒÖd od≈õwie≈ºania:', error);
                refreshButton.textContent = '‚ùå B≈ÇƒÖd';
                setTimeout(() => {
                    refreshButton.textContent = originalText;
                    refreshButton.disabled = false;
                }, 1500);
            }
        }

        function generujWOS() {
            const maszynista = document.getElementById("maszynista").value || "‚Äî";
            const input = stations.trim();
            if (input.length === 0) return;

            const wpisy = input.split(/[,;]\s*/).map(s => s.trim());

            const znalezioneStacje = wpisy.filter(nazwaWp => {
                const klucz = Object.keys(BAZA_OSTRZEZEN).find(k => normalizuj(k) === normalizuj(nazwaWp));
                return klucz !== undefined;
            });

            if (znalezioneStacje.length === 0) {
                let html = `
            <h1 style="margin:0 0 12px; font-size:15pt; text-align:center; color: var(--text-color);">
                Wykaz Ostrze≈ºe≈Ñ Sta≈Çych<br>
                oraz prƒôdko≈õci drogowych
            </h1>
            <span style="float:right;">Godzina wydruku: <b>${new Date().toLocaleTimeString('pl-PL')}</b></span>
            <span><br><br></span>
            <span>Wygenerowano dla pociƒÖgu: <b>${(() => {
                        const train = trainsData.filter(t => t.driverName === maszynista).find(t => t.timetable?.path);
                        const category = train?.timetable?.category || '';
                        const trainNo = train?.trainNo || '‚Äî';
                        return category ? `${category} ${trainNo}` : trainNo;
                    })()}</b></span>
            
            <div class="warning-message" style="margin: 20px 0; text-align: center; font-size: 1.1em;">
                <strong>‚ÑπÔ∏è Brak WOS dla danego rozk≈Çadu jazdy</strong><br>
                Trasa pociƒÖgu nie zawiera stacji zdefiniowanych w bazie ostrze≈ºe≈Ñ sta≈Çych.
            </div>`;

                document.getElementById("wynik").innerHTML = html;
                document.getElementById('printButton').disabled = true;
                return;
            }

            let html = `
        <h1 style="margin:0 0 12px; font-size:15pt; text-align:center; color: var(--text-color);">
            Wykaz Ostrze≈ºe≈Ñ Sta≈Çych<br>
            oraz prƒôdko≈õci drogowych
        </h1>
        <span style="float:right;">Godzina wydruku: <b>${new Date().toLocaleTimeString('pl-PL')}</b></span>
        <span><br><br></span>
        <span>Wygenerowano dla pociƒÖgu: <b>${(() => {
                    const train = trainsData.filter(t => t.driverName === maszynista).find(t => t.timetable?.path);
                    const category = train?.timetable?.category || '';
                    const trainNo = train?.trainNo || '‚Äî';
                    return category ? `${category} ${trainNo}` : trainNo;
                })()}</b></span>

        ${rysujWOS(wpisy)}`;
            document.getElementById("wynik").innerHTML = html;
            document.getElementById('printButton').disabled = false;
        }

        function rysujWOS(wpisy) {
            html = `<table class="wos-table">
            <thead>
                <tr>
                    <th style="width: 3em;" rowspan="2">Nazwa szlaku lub posterunku</th>
                    <th colspan="2">Lokalizacja</th>
                    <th style="width: 36%;" rowspan="2">Przyczyna</th>
                    <th style="width: 3.5em;" rowspan="2">Tor</th>
                    <th colspan="2">Prƒôdko≈õƒá</th>
                    <th style="width: 24%;" rowspan="2">Uwagi</th>
                </tr>
                <tr>
                    <th>od km</th>
                    <th>do km</th>
                    <th>niep.</th>
                    <th>parz.</th>
                </tr>
            </thead>
            <tbody>`;

            wpisy.forEach(nazwaWp => {
                const klucz = Object.keys(BAZA_OSTRZEZEN).find(k => normalizuj(k) === normalizuj(nazwaWp));
                if (!klucz) return;

                html += `<tr><td colspan="8" class="station-header">${klucz}</td></tr>`;
                const dane = [...BAZA_OSTRZEZEN[klucz]].sort((a, b) => parseFloat(a[0] || a[1] || 0) - parseFloat(b[0] || b[1] || 0));

                dane.forEach((item) => {
                    html += `
                <tr>
                  <td>${item["stacja"]}</td>
                  <td>${formatKm(item["odkm"])}</td>
                  <td>${formatKm(item["dokm"])}</td>
                  <td style="text-align:left;">${item["przyczyna"] || '‚Äî'}</td>
                  <td>${item["tor"] || '‚Äî'}</td>
                  <td>${item["vniep"] || '‚Äî'}</td>
                  <td>${item["vparz"] || '‚Äî'}</td>
                  <td style="text-align:left;">${item["uwagi"] || '‚Äî'}</td>
                </tr>`;
                });
            });

            html += "</tbody></table>";

            return html;
        }
    </script>
    <span style="float: right;"> Blue & Kacper9 & bagi2424</span><br><br>
    <section class="no-print">
        <span style="float: right;">version 1.2.0</span><br><br>
        <span style="float: right; font-size: 0.8em;">Dane pobierane za po≈õrednictwem API: <a
                href="https://stacjownik-td2.spythere.eu">Stacjownik</a></span>
    </section>
</body>

</html>
